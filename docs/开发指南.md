# 开发指南

## 概览

- 项目名称：实时语音信号处理系统（`real_time_voice_processing`）
- 目标：实时采集、处理与可视化语音信号，支持语音活动检测（VAD）
- 主要模块：`runtime/engine.py`、`ui/visualization.py`、`signal_processing/`、`config.py`

## 环境与依赖

- 推荐 Python 3.10（本项目在 3.10 上测试通过）
- 使用虚拟环境进行依赖隔离（遵循“项目依赖管理”约定）

### 快速开始（Windows PowerShell）

```powershell
# 创建并激活虚拟环境
py -3.10 -m venv .venv
.\.venv\Scripts\Activate.ps1

# 安装依赖（推荐使用包内 requirements）
pip install -r real_time_voice_processing\requirements.txt

# 或使用脚本一键创建（如已安装 PowerShell 7）
pwsh ./scripts/setup_venv.ps1
```

### Linux/macOS

```bash
python3.10 -m venv .venv
source .venv/bin/activate
pip install -r real_time_voice_processing/requirements.txt
```

## 运行与测试

- 运行主程序：`python -m real_time_voice_processing.main` 或 `python real_time_voice_processing/main.py`
- 运行演示脚本：`python real_time_voice_processing/demo.py`
- 运行单元测试：`pytest`

## 代码风格

- Python 文件命名使用 `snake_case`（示例：`signal_processing.py`）
- 使用 `black`（行宽 100）与 `flake8` 进行基本格式检查（配置见 `pyproject.toml`）

## 配置管理

- 全部运行参数集中在 `config.py` 的 `Config` 类中，包含音频、缓冲区、阈值、可视化与线程参数
- 常见修改：采样率（`SAMPLE_RATE`）、帧长（`FRAME_SIZE`）、能量与过零率阈值（`ENERGY_THRESHOLD`、`ZCR_THRESHOLD`）
- 音频格式（`AUDIO_FORMAT`）默认使用 `pyaudio.paInt16`；在未安装 PyAudio 的环境下，系统会自动回退到等效常量值以保证算法与测试可运行。

### 配置加载

- 支持从环境变量覆盖：`RTP_<配置项大写>`，例如：`RTP_SAMPLE_RATE=22050`
- 支持从 YAML 文件加载（需安装 `pyyaml`）：设置 `RTP_CONFIG_YAML=path/to/config.yaml`
- 初始化日志与配置推荐在入口调用：

```python
from real_time_voice_processing.config import Config
Config.setup_logging()
Config.load_from_yaml(os.environ.get("RTP_CONFIG_YAML"))
Config.load_from_env(prefix="RTP_")
```

## 目录结构（简化）

```text
.
├── docs/                          # 文档（Sphinx + Markdown）
├── real_time_voice_processing/     # 包源代码与包内文档
│   ├── main.py                     # 入口（启动运行时与 UI）
│   ├── config.py                   # 参数配置
│   ├── requirements.txt            # 依赖清单（包内）
│   ├── runtime/
│   │   ├── engine.py               # 采集与处理线程（运行时引擎）
│   │   └── audio_source.py         # 音频输入源抽象与实现
│   ├── signal_processing/          # 信号处理算法子包（拆分为多个模块）
│   │   ├── __init__.py             # 聚合类与兼容包装
│   │   ├── windows.py              # 窗函数
│   │   ├── preprocessing.py        # 预加重与分帧
│   │   ├── time_features.py        # 时域特征
│   │   ├── frequency_features.py   # 频域特征
│   │   └── vad.py                  # 语音活动检测
│   ├── ui/
│   │   └── visualization.py        # 可视化界面
│   └── demo.py                     # 功能演示脚本
├── scripts/
│   └── setup_venv.ps1              # Windows 创建虚拟环境脚本
├── tests/
│   ├── test_runtime_engine.py
│   └── test_signal_processing.py   # 算法单元测试
├── pyproject.toml                   # 构建与工具配置
└── Makefile                         # 构建脚本（跨平台，仓库根）
```

## 开发流程建议

- 新增算法时：在 `SignalProcessing` 中添加静态方法，并补充 `tests/` 测试
- UI 交互改动时：确保 `VisualizationUI` 与 `AudioRuntime` 的接口一致（例如 `get_recent_processed`）。使用 PyQt5 时，请通过 `pyqtgraph.Qt` 导入 `QtWidgets` 并使用其中的控件类（如 `QApplication`、`QPushButton`），避免使用已在 PyQt5 中迁移的 `QtGui` 控件类。
- 性能优化：优先向量化实现，适当调节 `AUDIO_BUFFER_SIZE` 与 `THREAD_SLEEP_TIME`

## 运行输入抽象

- 引擎支持通过音频源接口（`runtime/audio_source.py`）解耦输入：
  - `PyAudioSource`：系统麦克风实时采集（默认）
  - `FileAudioSource`：从文件顺序读取（用于跨平台/CI 测试与回放）
- 在入口通过环境变量选择文件输入：`RTP_INPUT_FILE=./example.wav`

## 日志与故障排查

- 使用标准日志记录运行信息（`Config.setup_logging()`），便于线上排查。
- 运行时引擎出现异常会记录到日志并保存在 `AudioRuntime.last_error` 字段。

## 文档约定

- 项目文档统一使用 Markdown
- 涉及公式的部分使用 LaTeX 语法，例如 `$E=mc^2$`

## 文档构建（Sphinx）

- 文档源位于 `docs/`，已接入 Sphinx 与 MyST（支持 Markdown）
- 生成 HTML 文档：

```bash
# 在仓库根目录执行（确保已安装依赖）
python -m pip install -r real_time_voice_processing/requirements.txt
sphinx-build -b html docs docs/_build/html
```

- 打开 `docs/_build/html/index.html` 即可浏览完整文档与 API
- 自动 API 文档通过 `autodoc` 从包源代码提取注释与签名

## 参考

- 详细架构与算法请参考《架构说明》和《算法说明》文档
